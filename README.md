# Long-read Single-Cell Analysis Pipeline (ONT + PIPseq)

This repository contains the analysis pipeline used for single-cell long-read data generated using our adapted PIPseq protocol for Oxford Nanopore Technologies (ONT) long-read sequencing. 

This analysis utilizes count matrices generated by our **Single-Cell Nextflow Pipeline**, available here: (https://github.com/UK-SBCoA-EbbertLab/single_cell_nextflow_pipeline).

**For full methodological details, please refer to our preprint: https://www.biorxiv.org/content/10.1101/2025.10.16.682832v1**

## Analysis Overview
This analysis pipeline consists of 10 main steps, including one optional step for AutoZI parameter tuning. We also include an additional optional step to compare novel isoforms against existing datasets that detected unannotated isoforms, which can be found in the /compare_annotations directory. 

All analyses were executed within a Singularity container, as detailed in our paper. See the /singularity_container directory for build files and instructions.

### Step 0 -- Initial Filtering
This step reduces file-size for efficient downstream processing by removing genes and isoforms expressed in very few cells, as well as cells likely representing empty droplets containing ambient RNA. The resulting filtered matrices were rounded to two decimal places to further minimize storage requirements and transposed for compatibility with downstream steps. 

This step is implimented in Java. For setup and usage details, refer to dedicated README.md in the Step 0 directory.

### Step 1 -- Count Matrix Preparation
This step annotates the expression matrices produced in Step 0 and prepares the structure for downsteam analyses. The GRCh38.113 GTF is parsed to add gene symbols corresponding to ensembl ID, and a combined ID  is generated with gene symbol, ensembl gene ID, and ensembl transcript ID (Gene-level-- SYMBOL:ENSGID; Isoform-level--SYMBOL:ENSGID:ENSTID. In the case of novel genes or transcripts or if a gene symbol is missing (such as in some RNA genes), the absent symbol is omitted (e.g., BambuGene# or BambuGene#:BambuTx#). These annotated matrices are written to Parquet matrices and stored as AnnData objects (.h5ad) for efficient storage and downstream loading.

### Step 2 -- Quality Control Filtering
This step loads the .h5ad matrices from Step 1 and computes per-cell, per-gene, and per-isoform quality control metrics. Cells are filtered according to the thresholds determined for total reads, % mitochondrial genes/isoforms, number of unique genes/isoforms, and % hemoglobin genes/isoforms, as defined in Table S2. Genes and isoforms with low expression in both replicates (<10 cells each) are removed. Doublet detection and removal are performed using the Scrublet package and the resulting filtered datasets are concatenated for downstream modeling. Optional summary statistics can be generated, as shown in Table S7 in the manuscript.

### Step 3 -- AutoZI Parameter Tuning (optional)
This step evaluates AutoZI model parameters on a small subset of the data to identify combinations that best represent the data. Parameter sets are compared based on convergence of training and validation ELBO curves, batch mixing performance, and general T cell marker expression cluster distinction. Parameter tuning is performed separately for gene and isoform parameter to improve efficiency, as AutoZI can be computationally intensive. The final parameters for Step 4 are chosen based the best fit for both gene- and isoform-level data.

### Step 4 -- AutoZI Modeling
Based on the optimal parameters determined from Step 3, the concatenated datasets from Step 2 undergo AutoZI modeling via these python scripts. Each modeling job requests 500GB of total memory and outputs error and training logs. The resulting trained models include latent representations and zero-inflation probabilities, which are stored within MuData (.h5mu) objects for integration with downstream analyses. Isoform and Gene modeling jobs are submitted separately. 

### Step 5 -- Cell-Type Assignment
This step initially verifies AutoZI model performance from Step 4 by inspecting ELBO convergence of training and validation data. Once model convergence is confirmed, denoised and batch-normalized expression values and latent spaces are used to perform KNN clustering. vompute UMAPs, and run Leiden clustering across multiple resolutions. Appropriate clustering resolution is determined based on cluster separation, batch mixing, and canonical marker patterns. Candidate immune markers for major immune cell types are evaluated from established flow cytometry markers. Candidate markers are visualized on individual UMAPs and iterative marker refinement is performed to assign cell-types with a high level of confidence. We then used the determined markers to assign cell-type and created Figures 3a-b and 3d-m from our manuscript. 

### Step 6 -- Bulk Figure Generation
This step generates Figure 1 and Supplemental Figure S1 in the manuscript, illustrating general trends in isoform length, structure, and characteristics of novel isoforms and genes. This script requires the original Ensembl GTF with biotypes (e.g., Homo_sapiens.GRCh38.113.gtf) and an extended annotation GTF produced by the preprocessing pipeline (e.g., extended_annotations.gtf). 

### Step 7 -- Sub-Cell Type Assignment
This step isolates the T cell cluster from the full dataset and identifies sub-cell-types based on canonical gene markers. Sub-cell-type marker refinement was performed similarly to step 5, and sub-cell-types were assigned, as shown in Figures 5a-b and 5f-m of the manuscript. 

### Step 8 -- Paper Figure Generation
This step generates dot-plots and heatmaps to visualize isoform-level differential expression of isoforms across cell-types and sub-cell-types. In our manuscript, the resulting figures can be seen in Figures 3c, 5c, 6a, and 6b. 

### Step 9 -- Unique / Raw Count Analyses
This step is used as a confirmation of raw and unique count expression for marker genes across cell-types and sub-cell-types to ensure the validity of these as markers on the cell-type-level, prior to AutoZI modeling and denoising. These analyses correspond to Figures 6d,e and Supplemental File 2 of our manuscript. 

### Step 10 -- RNAPysoform Analyses
This step models transcript structures for both known and new isoforms from known genes. It also adds biotypes to our extended GTF and assigns new transcripts to the biotype "novel" to allow biotype coloration for all transcripts in our dataset. These analyses produced Figures 6c and 6f in the manuscript.  

In this step, we use the RNAPysoform Python package created by Bernardo Aguzzoli Heberle in the Ebbert lab, which can be found here: https://rna-pysoforms.readthedocs.io/en/latest/. 


